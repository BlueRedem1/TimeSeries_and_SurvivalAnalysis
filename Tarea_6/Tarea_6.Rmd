---
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pressure2, echo=FALSE, out.width = '220%'}
knitr::include_graphics("CARATULA.PNG")
```

\newpage

Utiliza la base de datos de R llamada larynx, del paquete KMsurv, y realice lo 
siguiente:

# Ajuste de modelo
Ajuste un modelo de riesgos proporcionales de Cox para definir la contribución 
de las variables al tiempo de supervivencia de los pacientes.

```{r,echo=FALSE,message=FALSE}
#Cargamos librería y la base de datos
library(survminer)
library(survival)
library(KMsurv)
library(ggsci)
library(scales)
library(dplyr)
data("larynx")
attach(larynx) #Fijamos la base de datos
```

Hagamos un modelo de "Uno en uno" con el fin de ver cuales son significativos
y, posteriormente, hacer el modelo conjunto
## Modelo para etapa
```{r}
#Creamos el objeto
Surv_general <- Surv(larynx$time, larynx$delta,type = "right")

#Modelo de etapas
stage_model<-coxph(Surv_general~factor(stage)) 
stage_model
#Notamos que la base de comparación es la etapa 1
```
¡Tiene un p-value muy pequeño \textbf{conjuntamente}! Ello quiere decir que el coeficiente es significativo, y concuerda con lo obtenido en la tarea 5, 
donde vimos que para cada una de las etapas, el test de Log-Rank y de Wilcoxon generalizada nos dice que son funciones de supervivencia distintos, por ende es natural que haciendo un modelo de Cox, se tenga un parámetro significativo; sin embargoesto es de \textbf{manera conjunta}. 
Ya que el p-value del grupo de la etapa 2 es demasiado grande, probemos con 
las nuevas clasificaciones que probamos en la tarea 5:

Agrupando la eta 1 y 2:
```{r}
stage_aux<- larynx %>%
  mutate(stage_aux=factor(ifelse(stage %in% c(1,2),"1 o 2",stage)))
stage_fit_aux <- survfit(Surv_general ~ stage_aux, type = "kaplan-meier", 
                         conf.int = 0.95, conf.type = "plain",data=stage_aux)

stage_model_aux1<-coxph(Surv_general~factor(stage_aux),data=stage_aux) 
stage_model_aux1
#la etapa base es la 1 o 2
```
¡De manera conjunta tiene un p-value muy pequeño! y notemos que, si bien en la 
etapa 3 tiene un p-value de 0.0663, este es menor a 0.2, y vimos con la profesora
que, acorde a autores como Hosmer-Lemeshow, si tienen un p-value menor o igual
a 0.2, se deben considerar en el modelo múltiple
```{r}
stage_aux2<- larynx %>%
  mutate(stage_aux=factor(ifelse(stage %in% c(1,2),"Temprana(1,2)",
                                 "Avanzada(3,4)")))
stage_fit_aux <- survfit(Surv_general ~ stage_aux, type = "kaplan-meier", 
                         conf.int = 0.95, conf.type = "plain",data=stage_aux2)
stage_model_aux2<-coxph(Surv_general~factor(stage_aux),data=stage_aux2) 
stage_model_aux2
#La etapa base es la avanzada
```
Teneos un p-value demasiado pequeño, por lo que definitivamente es una variable
significativa bajo esta clasificación
## Modelo para edad
```{r}
age_model<-coxph(Surv_general~age)
age_model
```
Tiene un p-value mayor a 0.05, sin embargo, en clase vimos que autores como
Hosmer-Lemeshow consideran que, en un analisis exploratorio, las variables con 
un nivel de significancia menor o igual a 0.2 se consideren en el modelo multiple,
entonces podemos ingresar la variable de edad al modelo múltiple; ello coincide
un poco con lo que obtuvimos en la tarea 5: Que dada cierta clasificación en el
grupo de edad, sí había una diferencia significativa con base en los test.

Por curiosidad, veamos qué pasa con la clasificación que propusimos en la
tarea 5:
```{r}
aux_age<- larynx %>%
  mutate("Grupo"=cut(larynx$age,breaks=c(40,70,Inf)))
aux_age_model<- coxph(Surv_general~aux_age$Grupo,data = aux_age)
aux_age_model
#Notamos que la base es el grupo de 40 a 70
```
Podemos observar que bajo la clasificación en la que obtuvimos una función de
supervivencia distinta para ambos grupos en la tarea 5, tenemos aquí un p-value
menor a 0.05, por lo que concuerda con lo obtenido en los test de la tarea 
anterior. 

```{r}
diagyr_model<-coxph(Surv_general~diagyr)
diagyr_model
```
Definitivamente, no es una variable que aporte mucho: Su p-value es altísimo,
por lo que los coeficientes no son significativos inclusive bajo el criterio
del 0.2 propuesto por algunos autores como Hosmer-Lemeshow, por lo que no 
la consideraremos en el modelo conjunto.

Veamos el modelo en conjunto:

```{r}
modelo_conjunto<-coxph(Surv_general ~ factor(stage)+age)
modelo_conjunto
```
¡Conjuntamente, son significativos! El p-value es menor a 0.05; sin embargo
la edad y 2 de las etapas de la enfermedad tienen un p.value mayor a 0.05, por
lo que no son significativos de manera individual.

Y usando la clasificación de edades propuesta, hubiésemos tenido este modelo:
```{r}
modelo_conjunto_aux<-coxph(Surv_general ~ factor(stage)+Grupo,data=aux_age)
modelo_conjunto_aux
```
De la misma manera, y como se esperaba, usando los grupos propuestos para edad,
los coeficientes son significativos de manera conjunta. De hecho, el p-value
es menor que en el primer modelo conjunto obtenido en la línea anterior. Sin 
embargo, tenemos parámetros no significativos en las etapas de la enfermedad

```{r}
modelo_conjunto_aux<-coxph(Surv_general ~ factor(stage)+Grupo,data=aux_age)
modelo_conjunto_aux
```

# Análisis de los coeficientes de regresión

## Ejercicio 1 
¿Cuál es la estimación puntual para los coeficientes de regresión? Interprete 
los coeficientes de regresión.

### Estimación puntual 

### Interpretación

# Análisis del efecto de las variables en el modelo

## Ejercicio 2
¿Las variables explicativas tienen o no efecto en el modelo? Obtenga un intervalo 
de confianza al $95\%$ para la estimación de los coeficientes de regresión. Justifique.

### Efecto/significancia de kas variables explicativas en el modelo

### Intervalo del 95\% de confianza

# Análisis de supuesto de riesgos proporcionales

## Ejercicio 3
¿Es válido tu modelo de acuerdo al supuesto de riesgos proporcionales? Realice las 
pruebas de análisis de residuos y concluya.

###Pruebas de análisis de residuos