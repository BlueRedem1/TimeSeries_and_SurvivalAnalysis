---
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pressure2, echo=FALSE, out.width = '220%'}
knitr::include_graphics("CARATULA.PNG")
```

\newpage

Utiliza la base de datos de R llamada larynx, del paquete KMsurv, y realice lo siguiente:

Explique sus resultados.

# Análisis descriptivo

## Ejercicio 1

Realice un análisis descriptivo sobre el tiempo de supervivencia de los sujetos, además de sus características generales y particulares.


```{r,echo=FALSE,message=FALSE}
#Cargamos las librerías necesarias
library(survminer)
library(survival)
library(KMsurv)
library(ggsci)
library(scales)
data("larynx")
```

## Composición de la base
```{r}
attach(larynx)
head(larynx)
```
Esta base de datos es acerca del tiempo de supervivencia en pacientes que padecen cáncer
de larínge en distintas etapas.

Tenemos 5 variables y 90 observaciones:

Stage, que representa la etapa en la que se encuentra dicha enfermedad del paciente

Time. que nos dice el tiempo de la observación, en meses

Age, que es edad del paciente cuando se le diagnosticó la enfermedad

Diagyr, que es el año en que se diagnisticó la enfermedad

Delta, que es un indicador tal que es 1 si el paciente murió al tiempo de observación
y 0 y se encuentra vivo. En nuestro contexto, la muerte es la falla y el estar vivo
la censura

### NA y número de observaciones
```{r}
length(larynx$time)
sum(is.na.data.frame(larynx))
```

Tenemos 5 variables y 90 observaciones, no tenemos ningún NA. 

## Etapa
```{r}
#Usamos la paleta de lancet porque es una revista de oncología
Edad <- table(stage) 
names(Edad) <- unique(larynx$stage)
b <- barplot(Edad,col= palette(pal_lancet("lanonc")(5)),
             main="Gráfica de barras: Etapa de cáncer", col.main="cornflowerblue", 
             ylab="Frecuencia absoluta", col.lab="blue4")
text(x=b,y=c(Edad), labels=c(Edad), pos=3, col="deepskyblue4", cex=1.5, xpd=TRUE)
#Observaciones
Edad
#Porcentaje
Edad/.9
```
Podemos ver que la mayoría de las observaciones se concentran en pacientes en etapa 1,
que es la inicial, concentrando el 36.66\% de las observaciones, después sigue la
etapa 3, que tiene 27 observaciones las cuales representan el 30\% del total, 
seguidas de 17 observaciones en etapa 2, representando un 18.8\% y al final, como
resulta intuitivo, la etapa con menos observaciones es la 4, con 13 que representan 
el 14.4\% del total, esto porque es la etapa más avanzada y grave de la enfermedad,
por lo que es entendible que hayan menos pacientes de esta etapa y más de la primera,
pues es natural que existan más pacientes en dicho grupo.


## Edad
```{r,message=FALSE}
edad<-hist(age, probability=F, col=palette(pal_lancet("lanonc")(9)), border="gray0", 
     main="Histograma del tiempo de supervencia",col.main="darkorange4",ylab = "Frecuencia", col.lab = "darkgoldenrod4",
     xlab = "Edad", labels=TRUE,ylim=c(0,20)) 
#Puntos de corte
edad$breaks
#Cantidad
edad$counts
#Porcentaje
edad$counts/.9
```
Podemos ver que la mayoría de las observaciones se concentran entre 61 y 70 años,
teniendo 32 pacientes en dicho grupo de edad, y notamos que mientras se alejan 
de este grupo de edad, va decreciendo el número de pacientes en ese grupo de edad,
parece tener una forma parecida a una distribución simétrica, o acampanada,
pero no parece ser una normal, a primera vista, aunque le da un parecido.
el grupo más joven y el más viejo tienen la menor concentración de pacientes.

## Año de diagnóstico 
```{r}
year <- table(diagyr)
b <- barplot(year,col= palette(pal_lancet("lanonc")(5)),
             main="Gráfica de barras: Etapa de cáncer", col.main="indianred1", 
             ylab="Frecuencia absoluta", xlab = "Edad", col.lab="lightcoral",ylim=c(0,25))
text(x=b,y=c(year), labels=c(year), pos=3, col="gray0", cex=1.5, xpd=TRUE)
#Observaciones
year
#Porcentaje
year/.9
```
Tenemos que el año en el que más personas recibieron su diagnóstico fue en 1976,
con 19 personas que representan el 21.11\% de los pacientes.
Le sigue 1974 con 14 pacientes
Hay casi la mosma cantidad de pacientes cuyo diagnóstico fue en 1971,1973 y 1977,
siendo de 12 en el primero y 11 en los otros 2.
Después de esto, 1972 y 1975 tienen casi los mismos representantes, siendo 9 y 8
respectivamente
Posteriormente tenemos a 1978, que es el año más reciente, con 4 representantes.
Esto puede ser natural ya que, podría costar un poco de trabajo contactar a 
personas para el estudio que hayan recibido su diagnóstico muy recientemente,
si es que el estudio se realizó el mismo año.
Es de esperar que el año con menor pacientes registrados sea 1970, pues es el
año más lejano, con solo 2 pacientes.
##Fallas y censuras
```{r}
fallas <- table(delta)
names(fallas)<-c('Censura','Falla')  
b <- barplot(fallas,col= palette(pal_lancet("lanonc")(5)),
             main="Gráfica de barras: Etapa de cáncer", col.main="slateblue", 
             ylab="Frecuencia absoluta", col.lab="slateblue1",ylim=c(0,60))
text(x=b,y=c(fallas), labels=c(fallas), pos=3, col= c("red", "navy"), cex=1.5, xpd=TRUE)
fallas/.9
```
Tenemos 50 fallas, que representan el 55.55\% de nuestros datos, y 40 censuras,
que representan el 44.44\% de nuestros datos. Tenemos ligeramente más fallas que
censuras en nuestro estudio.
## Función de supervivencia
```{r}
Surv_general <- Surv(larynx$time, larynx$delta,type = "right")
general_fit <- survfit(Surv_general ~ 1, type = "kaplan-meier", conf.int = 0.95,
                       conf.type = "plain",data=larynx)
plot(general_fit, main="Supervivencia", xlab =  "t = meses", ylab = "S(t)",
           col="blue1", las=1) 
ggsurvplot(general_fit, data=larynx,palette = "violetred3",censor.size=7, 
           censor.shape= 124)
```
Podemos observar que al inicio del estudio, en los primeros dos meses, se tiene
una gran cantidad de fallas, seguido por el periodo de 3 a 4 meses y de 6 a 6 y medio meses,
aproximadamente; siendo los periodos donde más se concentran las fallas.\

Otro punto a destacar es que no llegamos a $0$ en la función de supervivencia, esto 
porque los últimos datos son censuras, como podemos ver en el dataset (en este contexto 
es que se encuentran vivos).\

Podemos notar un periodo de estabilidad, donde la función de supervivencia se mantiene
constante, en el periodo de aproximadamente 4 meses y medio a poco antes de 6, 
si bien tenemos fallas, estas son pocas, por lo que se mantiene casi constante en
el periodo mencionado, aunque existen muchas fallas (bajo este contexto, ello significa
que el sujeto de estudio se encontraba vivo al tiempo de observación).

Al inicio, los intervalos de confianza están bastante cercanos al estimador puntual.\
Los intervalos de confianza se hacen muy grandes hacia el final de la función de 
supervivencia, pero sesgados hacia la derecha, es decir, el intervalo de confianza
superior tiene una distancia mayor al estimador puntual, respecto del intervalo inferior.\

Dicho lo anterior, se puede intuir que los primeros dos meses son los 'más difíciles', 
puesto que hay muchas fallas en este periodo (son frecuentes y es donde más se acumulan), 
pero observamos que conforme se acerca a los 8 meses se entra a un periodo "seguro",
donde las fallas son casi nulas, y al tiempo de observación vemos sujetos vivos (fallas)
únicamente; teniendo un valor de entre 0.22 y 0.40 aproximadamente, la función de supervivencia
con los intervalos de confianza, y de aproximadamente 0.26 con el estimador puntual,
por lo que tienen todavía una "Buena" probabilidad de sobrevivir al menos hasta este
periodo.

# Kaplan-Meier

## Ejercicio 2

Con el estimador de Kaplan-Meier para la función de supervivencia S(t), calcule y grafique:
 S(t) poblacional.
 S(t) por estadio de la enfermedad.
 S(t) por grupos de edad.
Identifique las variables que afectan el tiempo de supervivencia. Incluya los intervalos del 95\% confianza.

## S(t) poblacional

Este ya lo calculamos en el inciso anterior:

```{r}
summary(general_fit)
plot(general_fit, main="Supervivencia", col="red", las=1) 
ggsurvplot(general_fit, data=larynx,palette = 'lancet',censor.size=4.9,
           censor.shape=124)
```


## S(t) por estadio de la enfermedad



## S(t) por grupos de edad


# Pruebas Log-Rank con $\alpha=0.05$

## Ejercicio 3

Usando pruebas No paramétricas Log-Rank:

## Por estadio

Compare las funciones de supervivencia por estadio, es decir, realice el contraste 
de hipótesis:

$$H_0: S_j(t)=S_k(t) \forall t >0, \forall j,k\textbf{.         vs        .} H_a: S_j(t) \not = S_k(t);\textbf{p.a }t>0, p.a j\not = k.$$

## Por grupo de edad

Compare las funciones de supervivencia por grupos de edad
